"""
Loads the region pkl generated by fire_look.py, generates RGBs, and
performs the Flasse and Ceccato fire detection algorithm with a FireDetector.
"""

import pickle as pkl
import numpy as np
import json
from pathlib import Path
from pprint import pprint as ppt

from aes670hw2 import FireDetector
from aes670hw2 import PixelCat
from aes670hw2 import enhance
from aes670hw2 import guitools as gt
from aes670hw2 import geo_plot as gp

region_pkl = Path("data/pkls/20180904_amazon_fire.pkl")
json_path = Path("data/fire_classes.json")
figure_dir = Path("figures/fire_look/")
with region_pkl.open('rb') as pklfp:
    data, info, geo = pkl.load(pklfp)

debug = True
image_path = Path("figures/fire_look/amazon_fire_rgb.png")

""" Load the data and make a PixelCat band for the SWIR-LWIR diff array """
pc = PixelCat(
        [ X[::-1,::-1] for X in data],
        ("LWIR", "SWIR", "VIS"))
pc.set_band(pc.band("SWIR")-pc.band("LWIR"), "IRdiff")

""" Get an RGB of the 3 condition bands """
# RGB recipe selected using fire_categories.py
rgb_bands =["IRdiff", "LWIR", "VIS"]
rgb = pc.get_rgb(
        bands=rgb_bands,
        recipes=[lambda X: enhance.linear_gamma_stretch(X),
                 lambda X: enhance.linear_gamma_stretch(X)*(1/3),
                 lambda X: enhance.linear_gamma_stretch(X) ],
        #recipes=[lambda X: enhance.linear_gamma_stretch(X, gamma=.11),
        #         lambda X: enhance.linear_gamma_stretch(X)*(1/3),
        #         lambda X: enhance.linear_gamma_stretch(X, gamma=.13) ],
        show=False, debug=debug)

fire_color = np.asarray([255,113,61])
fd = FireDetector()
fc_cand_px = fd.get_candidates(
        pc.band("LWIR"), pc.band("SWIR"), pc.band("VIS")).candidates

""" Show the pixels identified as fire candidates """
fc_cand_rgb = enhance.norm_to_uint(np.copy(rgb), 256, np.uint8)
fc_cand_rgb[fc_cand_px] = fire_color
gt.quick_render(fc_cand_rgb)
print("Flasse and Ceccato Candidates")
gt.quick_render(fc_cand_rgb)
gp.generate_raw_image(fc_cand_rgb, figure_dir.joinpath(
    "amazon_fc_cand.png"))

""" Validate pixels identified as fire candidates """
fc_fire_px = fd.test_candidates(fc_cand_px, pc.band("LWIR"),
                             pc.band("SWIR"), pc.band("VIS"))
print(f"Fires identified: {len(fc_fire_px[0])}")
fc_fire_rgb = enhance.norm_to_uint(np.copy(rgb), 256, np.uint8)
fc_fire_rgb[fc_fire_px] = fire_color
gp.generate_raw_image(fc_fire_rgb, figure_dir.joinpath(
    "amazon_fc_fires.png"))

""" Modify thresholds and show the new candidates """
#'''
fd.swir_thresh_lbound = 314
fd.lwir_thresh_lbound = 280
fd.swir_lwir_diff_lbound = 15
fd.nir_ref_ubound = .1
#'''
my_cand_px = fd.get_candidates(
        pc.band("LWIR"), pc.band("SWIR"), pc.band("VIS")).candidates
my_cand_rgb = enhance.norm_to_uint(np.copy(rgb), 256, np.uint8)
my_cand_rgb[my_cand_px] = fire_color
gt.quick_render(my_cand_rgb)
gp.generate_raw_image(my_cand_rgb, figure_dir.joinpath(
    "amazon_my_candidates.png"))

""" Validate pixels identified as fire candidates """
my_fire_px = fd.test_candidates(my_cand_px, pc.band("LWIR"),
                                pc.band("SWIR"), pc.band("VIS"))
my_fire_rgb = enhance.norm_to_uint(np.copy(rgb), 256, np.uint8)
my_fire_rgb[my_fire_px] = fire_color
print(f"Fires identified: {len(my_fire_px[0])}")
gp.generate_raw_image(my_fire_rgb, figure_dir.joinpath("amazon_my_fires.png"))
